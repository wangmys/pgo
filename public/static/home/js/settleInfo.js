$(function(){cloudCart2Coupon.init();cloudCart2Card.init();cloudCart2Mobile.init()});var cloudCart2Coupon={init:function(){this.bindEvent.init()},bindEvent:{selectCoupon:function(selectObj){var couponType=selectObj.val().split(",")[1];if(couponType!="0"){var fusionList=selectObj.attr("fusionlist");if(isEmpty(fusionList)){fusionList=""}var couponArray="";$("#m-coupon-content1").find(":checkbox").not(selectObj).each(function(){couponArray=$(this).val().split(",");if(couponArray[1]!="0"&&fusionList.indexOf(couponArray[0])<0){$(this).attr("disabled","disabled").parents("tr").addClass("freeze")}})}},clickCoupon:function(clickObj){if(clickObj.prop("checked")){cloudCart2Coupon.bindEvent.selectCoupon(clickObj)}else{var dep=$("#m-coupon-content1");dep.find(":checkbox").removeAttr("disabled").parents("tr").removeClass("freeze");dep.find(":checkbox").siblings("label").removeClass("hide");$("#m-coupon-content1").find("input:enabled:checked").each(function(){cloudCart2Coupon.bindEvent.selectCoupon($(this))})}},init:function(){$("#step5").on("click","#coupon_finish_id .coupon-finish-list-box .change",function(){cloudCart2Coupon.bindEvent.editCoupon(true);return false});this.bindingCoupon();this.saveCoupon();this.displayPassword();this.removeCoupon();$("#step5").on("click",".ui-tooltip .close",function(){$(this).closest(".ui-tooltip").remove()})},editCoupon:function(isClick){probeAuthStatus(function(){$.ajax({type:"post",url:"editCoupon.do",data:cloudCart2Cmmdty.packParamForCoupo(),dataType:"json",contentType:"application/json; charset=utf-8",success:function(data){if(data.returnCode==="001"){cloudCart2Common.alertBox("优惠券信息加载失败，请您稍后再试！")}else{if(data.returnCode==="4000"){cloudCart2Common.alertBox("您访问的太频繁， 网络拥堵，请您稍后再试！")}else{if(data.returnCode==="004"){window.location.href="http://shopping.suning.com/error.do"}else{$("#coupon_ID").html(data.html);cloudCart.supportPlaceHolder.init("#coupon_finish_id");if(isClick&&!$("#coupon_title").hasClass("open")){$("#coupon_finish_id").show();$("#coupon_title").addClass("open")}cloudCart.tab({selector:$("#coupon-title")});cloudCart2.promotion.init();$("#m-coupon-content1").find("input:enabled:checked").each(function(){cloudCart2Coupon.bindEvent.selectCoupon($(this))})}}}}})},function(){cloudCart2Common.cart2Logon()})},bindingCoupon:function(){$("#step5").on("click","#add-coupon",function(e){probeAuthStatus(function(){var couponNo=$.trim(cloudCart2Common.getInputVal($("#coupon_num")));if(!cloudCart2Coupon.checkCouponNum(couponNo)){return}if(!cloudCart2Coupon.checkHasBindCoupon(couponNo)){return}if(!$("#coupon_passw").hasClass("hide")&&!cloudCart2Coupon.checkCouponPwd($.trim($("#coupon_passw").val()))){return}else{cloudCart2Coupon.sumbitBindCoupon()}},function(){cloudCart2Common.cart2Logon()});e.preventDefault()})},saveCoupon:function(){$("#step5").on("click","#coupon_savebtnID",function(e){probeAuthStatus(function(){var jsonStr;var coupons="";var couponUsedNum=0;var totalCoupon=0;jsonStr='{"cart2No":"'+$("#cart2No").val()+'", ';$("#coupon_ID").find("input[name='checkbox']:checked").each(function(){coupons+=$(this).val()+";";couponUsedNum++;totalCoupon+=parseFloat($(this).attr("payamount"))});if(!cloudCart2Coupon.checkSaveCoupon(couponUsedNum,totalCoupon)){return}$("#coupon_savebtnID").hide();$("#coupon_processID").show();var couponsArray=coupons.split(";");jsonStr+='"cart2CouponSingleList":[';for(var i=0;i<couponsArray.length;i++){if(couponsArray[i]!=""){var couponDetailArray=couponsArray[i].split(",");var couponNo=couponDetailArray[0];if(couponNo.indexOf("-")>=0){couponNo=couponNo.split("-")[0]}var couponType=couponDetailArray[1];var oldCouponType=couponDetailArray[2];var payAmount=couponDetailArray[3];var shopCode=couponDetailArray[4];var useRuleDesc=$("#coupon_"+couponNo).find("a").next().html();jsonStr+="{";jsonStr+='"couponNo":"'+couponNo+'","oldCouponType":"'+oldCouponType+'","couponType":"'+couponType+'","usedAmount":"'+payAmount+'","shopCode":"'+shopCode+'","useRuleDesc":"'+useRuleDesc+'"';jsonStr+="},"}}jsonStr=jsonStr.substring(0,(jsonStr.length-1));jsonStr+="]}";$.ajax({type:"POST",url:"saveCoupon.do",dataType:"json",contentType:"application/json; charset=utf-8",data:jsonStr,success:function(data){if(data.returnCode==="Y"||data.returnCode==="PY"){if($("#shippingChargeID").html()!==data.transportFee){cloudCart2Cmmdty.deliveryClick($(":checked[name='choose-package-type']").get(0),"N")}$("#coupon_finish_id").html(data.couponFinishHtml);$("#cmmdyTotalID").html(data.totalAmount);$("#shippingChargeID").html(data.transportFee);$("#cmmdyDiscountID").html(data.voucherTotalAmount);$("#freeAmountID").html(data.freeUsingAmount);$("#payAmountID").html(data.payAmount);$("#energySubsidiesID").html(data.energySubsidiesAmount);$("#card_content_id").html("").hide();$("#card_content_id").siblings(".toggle-title").removeClass("open");cloudCloudDiamond.cleanCloudDiamond()}else{if(data.returnCode==="4000"){cloudCart2Common.alertBox("您访问的太频繁， 网络拥堵，请您稍后再试！");$("#coupon_savebtnID").show();$("#coupon_processID").hide()}else{var errors=data.errorMsgList;var length=errors.length;var code="";var errorTip="";for(var i=0;i<length;i++){code=errors[i].errorCode;if(code==="004"){window.location.href="http://shopping.suning.com/error.do";return}else{errorTip=errors[i].errorMessage}break}$("#coupon_saveError").html("<i class='tip-icon tip-error-16'></i>"+errorTip).addClass("error-message");$("#coupon_savebtnID").show();$("#coupon_processID").hide()}}},error:function(){$("#coupon_savebtnID").show();$("#coupon_processID").hide();cloudCart2Common.alertBox("保存使用券失败，请您稍后再试！")}})},function(){cloudCart2Common.cart2Logon()});e.preventDefault()})},displayPassword:function(){$("#step5").on("keyup","#coupon_num",function(){var couponNo=$.trim(cloudCart2Common.getInputVal($("#coupon_num")));$("#coupon_error").html("").hide().parent(".row").removeClass("error-row");if(couponNo.length===14){if(($("#m-coupon-content1").find("#real_coupon_"+couponNo).size()<1)&&($("#m-coupon-content2").find("#real_coupon_"+couponNo).size()<1)){$("#coupon_passw").removeClass("hide")}else{cloudCart2Coupon.checkCouponNum(couponNo)}}else{$("#coupon_passw").val("").addClass("hide")}})},removeCoupon:function(){$("#step5").on("click","#coupon_finish_id .coupon-finish-list-box .cancel",function(){probeAuthStatus(function(){$.ajax({type:"post",url:"removeCoupon.do",data:{cart2No:$("#cart2No").val()},cache:"false",dataType:"json",success:function(data){if(data.returnCode==="Y"){if($("#shippingChargeID").html()!==data.transportFee){cloudCart2Cmmdty.deliveryClick($(":checked[name='choose-package-type']").get(0),"N")}$("#cmmdyTotalID").html(data.totalAmount);$("#shippingChargeID").html(data.transportFee);$("#cmmdyDiscountID").html(data.voucherTotalAmount);$("#freeAmountID").html(data.freeUsingAmount);$("#payAmountID").html(data.payAmount);$("#energySubsidiesID").html(data.energySubsidiesAmount);cloudCloudDiamond.cleanCloudDiamond();$("#card_content_id").html("").hide();$("#card_content_id").siblings(".toggle-title").removeClass("open");$("#coupon_finish_id").html("").hide();$("#coupon_title").removeClass("open")}else{if(data.returnCode==="4000"){cloudCart2Common.alertBox("您访问的太频繁， 网络拥堵，请您稍后再试！")}else{var errors=data.errorMsgList;var length=errors.length;var code="";var errorTip="";for(var i=0;i<length;i++){code=errors[i].errorCode;if(code==="004"){window.location.href="http://shopping.suning.com/error.do"}else{errorTip=errors[i].errorMessage;cloudCart2Common.alertBox(errorTip)}break}}}},error:function(){cloudCart2Common.alertBox("取消使用券失败，请您稍后再试！")}})},function(){cloudCart2Common.cart2Logon()});return false})}},checkCouponNum:function(couponNo){var errorMessege="";var couponLength=couponNo.length;if(couponNo===""||couponNo==="请输入优惠券号"){errorMessege="请您输入券号"}else{if(!((couponLength>2&&couponLength<10)||couponLength==11||couponLength==13||couponLength==14)){errorMessege="请核对您的号码位数，重新输入"}else{if(couponLength!==13&&isNaN(couponNo)){errorMessege="请输入正确的券号"}}}if(errorMessege!=""){$("#coupon_bind").addClass("error-row");$("#coupon_error").html("<i class='tip-icon tip-error-16'></i>"+errorMessege).show();sendSaMessage("coupon_num",errorMessege);return false}sendSaMessage("coupon_num","");return true},checkHasBindCoupon:function(couponNo){var errorMessege="";if(cloudCart2Coupon.isParentCouponNo(couponNo)){return true}if($("#m-coupon-content2").find("#real_coupon_"+couponNo).size()>0){$("#availableCoupon").removeClass("selected");$("#unavailableCoupon").addClass("selected");$("#m-coupon-content1").hide();$("#m-coupon-content2").show();errorMessege="您输入的券号已存在，请勿重复添加"}else{if($("#m-coupon-content1").find("#real_coupon_"+couponNo).size()>0){$("#unavailableCoupon").removeClass("selected");$("#availableCoupon").addClass("selected");$("#m-coupon-content1").show();$("#m-coupon-content2").hide();errorMessege="您输入的券号已存在，请勿重复添加"}}$("#coupon_finish_id").find(".rebind").removeClass("selected");if(errorMessege!=""){$("#real_coupon_"+couponNo).parents("tr").addClass("selected rebind");$("#coupon_bind").addClass("error-row");$("#coupon_error").html("<i class='tip-icon tip-error-16'></i>"+errorMessege).show();$("#coupon_passw").val("").addClass("hide");sendSaMessage("coupon_num",errorMessege);return false}sendSaMessage("coupon_num","");return true},checkCouponPwd:function(couponPwd){var errorMessege="";if(couponPwd===""){errorMessege="您输入的券号需要密码，请您输入密码"}else{if(!checkInvalidChar(couponPwd)){errorMessege="您输入的密码有误"}else{if(couponPwd.length!=6){errorMessege="您输入的密码位数有误"}}}if(errorMessege!=""){$("#coupon_bind").addClass("error-row");$("#coupon_error").html("<i class='tip-icon tip-error-16'></i>"+errorMessege).show();sendSaMessage("coupon_passw",errorMessege);return false}sendSaMessage("coupon_passw","");return true},checkSaveCoupon:function(couponUsedNum,totalCoupon){var errorMessege="";if(couponUsedNum===0){errorMessege="温馨提示：请选择使用的优惠券"}if(errorMessege!=""){$("#coupon_saveError").html("<i class='tip-icon tip-error-16'></i>"+errorMessege).addClass("error-message");return false}return true},sumbitBindCoupon:function(){var cpNum=$.trim(cloudCart2Common.getInputVal($("#coupon_num")));var cpPassw=$.trim($("#coupon_passw").val());$.ajax({type:"post",url:"bindCoupon.do",async:false,dataType:"json",data:{couponNum:cpNum,password:cpPassw,cart2No:$("#cart2No").val()},success:function(bindCouponData){if(bindCouponData.returnCode==="Y"){$.ajax({type:"post",url:"editCoupon.do",data:cloudCart2Cmmdty.packParamForCoupo(),dataType:"json",contentType:"application/json; charset=utf-8",data:{cart2No:$("#cart2No").val(),cityCode:$("#addressbox").attr("citycode"),deliveryMode:$("#deliveryType").val(),payment:$("#payType").val()},success:function(data){if(data.returnCode==="001"){cloudCart2Common.alertBox("优惠券信息加载失败，请您稍后再试！")}else{if(data.returnCode==="4000"){cloudCart2Common.alertBox("您访问的太频繁， 网络拥堵，请您稍后再试！")}else{if(data.returnCode==="004"){window.location.href="http://shopping.suning.com/error.do"}else{$("#coupon_ID").html(data.html);cloudCart.supportPlaceHolder.init("#coupon_finish_id");cloudCart.tab({selector:$("#coupon-title")});cloudCart2.promotion.init();if($("#m-coupon-content2").find("#real_coupon_"+cpNum).size()>0){$("#availableCoupon").removeClass("selected");$("#unavailableCoupon").addClass("selected");$("#m-coupon-content1").hide();$("#m-coupon-content2").show();if(!cloudCart2Coupon.isParentCouponNo(cpNum)){$("#real_coupon_"+cpNum).parents("tr").addClass("selected rebind")}$("#coupon_bind").addClass("error-row");$("#coupon_error").html("<i class='tip-icon tip-error-16'></i>您的券已经添加成功，但不能在当前订单中使用").show();$("#coupon_finish_id").find(".btn").trigger("click");if($("#m-coupon-content1").length===0){$("#coupon_title").trigger("click")}}$("#m-coupon-content1").find("input:enabled:checked").each(function(){cloudCart2Coupon.bindEvent.selectCoupon($(this))})}}}},error:function(){cloudCart2Common.alertBox("优惠券信息加载失败，请您稍后再试！")}})}else{if(bindCouponData.returnCode==="4000"){cloudCart2Common.alertBox("您访问的太频繁， 网络拥堵，请您稍后再试！")}else{$("#coupon_bind").addClass("error-row");var message="";if(bindCouponData.returnCode==="049"){message="您输入的直降代码无效！"}else{message=bindCouponData.errorMessage}$("#coupon_error").html("<i class='tip-icon tip-error-16'></i>"+message).show()}}},error:function(){cloudCart2Common.alertBox("绑定券失败，请您稍后再试！")}});return false},isParentCouponNo:function(couponNo){return((couponNo.length>=3&&couponNo.length<=9)||couponNo.length==11)&&(couponNo.indexOf("020")===0)}};var cloudCart2Card={init:function(){this.bindEvent.init()},showCard:function(){probeAuthStatus(function(){$.ajax({type:"post",url:"showCardList.do",data:{cart2No:$("#cart2No").val()},cache:false,dataType:"json",success:function(data){if(data.returnCode==="Y"){$("#card_content_id").html(data.html);cloudCart.supportPlaceHolder.init(".gift-card-item");cloudCart2.promotion.bindEvent();cloudCart2.promotion.getCheck.init()}else{if(data.returnCode==="4000"){cloudCart2Common.alertBox("您访问的太频繁， 网络拥堵，请您稍后再试！")}else{cloudCart2Common.alertBox("苏宁卡信息加载失败，请您稍后再试！")}}},error:function(){cloudCart2Common.alertBox("苏宁卡信息加载失败，请您稍后再试！")}})},function(){cloudCart2Common.cart2Logon()})},sendAuthCode:function(){$(".get-check-btn").addClass("cart-btn-disable");probeAuthStatus(function(){$.ajax({type:"post",url:"sendAuthCode.do",cache:false,dataType:"json",success:function(data){$(".get-check-btn").removeClass("cart-btn-disable");var code=data.returnCode;if(code==="4000"){cloudCart2Common.alertBox("您访问的太频繁， 网络拥堵，请您稍后再试！")}else{if(code==="023"){$("#card_content_id .step-btn .error-message").removeClass("hide").html("<i class='tip-icon tip-error-16'></i>"+data.tip);$(".get-check-btn").addClass("cart-btn-disable");$(document).off("click",".get-check-btn:not(.cart-btn-disable)")}else{cloudCart2.promotion.getCheck.getNum()}}},error:function(){cloudCart2.promotion.getCheck.getNum()}})},function(){cloudCart2Common.cart2Logon()})},bindEvent:{init:function(){this.editCard();this.cancel();this.bindingCard();this.saveCard();$("#step5").on("click","#card_content_id .gift-card-list-box table .checkbox",function(){if($("#card_content_id .gift-card-list-box table input:checked:not(.not-auth-code)").length===0){$("#card_content_id .gift-card-list-box .vaild-phone-box").addClass("hide");$("#card_content_id .step-btn .error-message").addClass("hide").html("")}else{$("#card_content_id .gift-card-list-box .vaild-phone-box").removeClass("hide")}})},editCard:function(){$("#step5").on("click","#card_content_id .gift-cart-finish-list-box .change",function(){probeAuthStatus(function(){$.ajax({type:"post",url:"editCardInfo.do",data:{cart2No:$("#cart2No").val()},cache:false,dataType:"json",success:function(data){if(data.returnCode==="Y"){$("#card_content_id").html(data.html);cloudCart.supportPlaceHolder.init("#card_content_id");if($("#card_content_id .gift-card-list-box table input:checked:not(.not-auth-code)").length===0){$("#card_content_id .gift-card-list-box .vaild-phone-box").addClass("hide");$("#card_content_id .step-btn .error-message").addClass("hide").html("")}else{$("#card_content_id .gift-card-list-box .vaild-phone-box").removeClass("hide")}cloudCart2.promotion.bindEvent()}else{if(data.returnCode==="4000"){cloudCart2Common.alertBox("您访问的太频繁， 网络拥堵，请您稍后再试！")}else{cloudCart2Common.alertBox("苏宁卡信息加载失败，请您稍后再试！")}}},error:function(){cloudCart2Common.alertBox("苏宁卡信息加载失败，请您稍后再试！")}})},function(){cloudCart2Common.cart2Logon()})})},cancel:function(){$("#step5").on("click","#card_content_id .gift-cart-finish-list-box .cancel",function(){probeAuthStatus(function(){$.ajax({type:"post",url:"useCard.do",data:{cart2No:$("#cart2No").val(),cardUsedInfo:"[]"},cache:false,dataType:"json",success:function(data){if(data.returnCode=="4000"){cloudCart2Common.alertBox("您访问的太频繁， 网络拥堵，请您稍后再试！");return}if(data.result.isSuccess){$("#cmmdyTotalID").html(data.result.totalAmount);$("#shippingChargeID").html(data.result.transportFee);$("#cmmdyDiscountID").html(data.result.voucherTotalAmount);$("#freeAmountID").html(data.result.freeUsingAmount);$("#payAmountID").html(data.result.payAmount);$("#energySubsidiesID").html(data.result.energySubsidiesAmount);$("#card_content_id").html("");$(".gift-card-item .toggle-title").removeClass("open");$("#card_content_id").hide()}},error:function(){cloudCart2Common.alertBox("取消使用卡失败，请您稍后再试！")}})},function(){cloudCart2Common.cart2Logon()})})},bindingCard:function(){$("#step5").on("click","#add-gift-card-btn",function(e){probeAuthStatus(function(){var cardNo=cloudCart2Common.getInputVal($("#cardno"));var password=$.trim($("#password").val());if(!cloudCart2Card.checkBind(cardNo,password)){return}$.ajax({type:"post",url:"bindCard.do",data:{cardNo:cardNo,password:password},cache:false,dataType:"json",success:function(data){if(data.returnCode=="4000"){cloudCart2Common.alertBox("您访问的太频繁， 网络拥堵，请您稍后再试！");return}var errorTip=data.errorMessage;if(errorTip===""){var cardList=$("#card_content_id table").find(".item");var lineColor="even";var firstLine=$(cardList.get(0));if(cardList.length===0||firstLine.hasClass("even")){lineColor=""}var newCard="";if(data.cardType==="2"){newCard="<tr class='item selected "+lineColor+" cart-checkbox-checked'><td><div class='cart-checkbox'><input type='checkbox' class='checkbox not-auth-code' checked='checked' value='"+data.cardNo+","+data.cardType+","+data.password+"' id='j_cartNO_"+data.cardNo+"' /><label for='j_cartNO_"+data.cardNo+"' class='check-icon'></label></div></td><td  id='"+data.cardNo+"'>"+data.cardNo+"</td><td>"+data.cardName+"</td><td><span class='sn-price'><i>&yen;</i><em>"+data.denomination+"</em></span></td><td><span class='sn-price'><i>&yen;</i><em  id='amount''>"+data.availableAmount+"</em></span></td><td>"+data.expireTime+"</td><td>"+data.description+"</td></tr>"}else{newCard="<tr class='item selected "+lineColor+" cart-checkbox-checked'><td><div class='cart-checkbox'><input type='checkbox' class='checkbox' checked='checked' value='"+data.cardNo+","+data.cardType+"' id='j_cartNO_"+data.cardNo+"' /><label for='j_cartNO_"+data.cardNo+"' class='check-icon'></label></div></td><td  id='"+data.cardNo+"'>"+data.cardNo+"</td><td>"+data.cardName+"</td><td><span class='sn-price'><i>&yen;</i><em>"+data.denomination+"</em></span></td><td><span class='sn-price'><i>&yen;</i><em  id='amount''>"+data.availableAmount+"</em></span></td><td>"+data.expireTime+"</td><td>"+data.description+"</td></tr>"}if(cardList.length===0){$("#noCardTip").remove();$("#card_content_id .gift-card-list-box").removeClass("hide").find("table").append(newCard);$("#card_content_id .gift-card-list-box .step-btn").removeClass("hide")}else{firstLine.before(newCard)}if($("#card_content_id .gift-card-list-box table input:checked:not(.not-auth-code)").length===0){$("#card_content_id .gift-card-list-box .vaild-phone-box").addClass("hide");$("#card_content_id .step-btn .error-message").addClass("hide").html("")}else{$("#card_content_id .gift-card-list-box .vaild-phone-box").removeClass("hide")}$("#card_content_id .add-gift-card-form div").removeClass("error-row").find(".tip-message").addClass("hide").html("");cloudCart2.promotion.bindEvent()}else{$("#card_content_id .add-gift-card-form div").addClass("error-row").find(".tip-message").removeClass("hide").html("<i class='tip-icon tip-error-16'></i>温馨提示："+errorTip)}},error:function(){cloudCart2Common.alertBox("绑定卡失败，请您稍后再试！")}})},function(){cloudCart2Common.cart2Logon()});e.preventDefault()})},saveCard:function(){$("#step5").on("click","#card_content_id .save-gift-card-btn",function(e){probeAuthStatus(function(){var jsonStr="[";var authCode=cloudCart2Common.getInputVal($("#authcode-input"));var cards=$("#card_content_id table tbody tr :checked");if(!cloudCart2Card.checkUseCard(authCode,cards)){return}if(cards.length!==0){cards.each(function(){var value=$(this).val().split(",");var amount=$.trim($(this).parents("tr").find("#amount").html());if(value[0]==="—"){value[0]=""}jsonStr+="{'cardNo':'"+value[0]+"','cardType':'"+value[1]+"','usedAmount':'"+amount+"'";if(value[1]==="2"){jsonStr+=",'password':'"+value[2]+"'"}jsonStr+="},"});jsonStr=jsonStr.substring(0,(jsonStr.length-1))}jsonStr+="]";$.ajax({type:"post",url:"useCard.do",cache:false,dataType:"json",data:{cart2No:$("#cart2No").val(),cardUsedInfo:jsonStr,authCode:authCode},success:function(data){if(data.returnCode=="4000"){cloudCart2Common.alertBox("您访问的太频繁， 网络拥堵，请您稍后再试！");return}var isSuccess=data.result.isSuccess;if(isSuccess==="Y"){$("#card_content_id").html(data.cardHtml);$("#cmmdyTotalID").html(data.result.totalAmount);$("#shippingChargeID").html(data.result.transportFee);$("#cmmdyDiscountID").html(data.result.voucherTotalAmount);$("#freeAmountID").html(data.result.freeUsingAmount);$("#payAmountID").html(data.result.payAmount);$("#energySubsidiesID").html(data.result.energySubsidiesAmount);if(data.result.integralAmount>0){cloudCloudDiamond.cleanCloudDiamond();cloudCloudDiamond.fillingCloudDiamond(data.result.integralQuantity,data.result.integralAmount)}cloudCart2.promotion.bindEvent()}else{var errors=data.result.errorMsgList;var length=errors.length;var errorTip="";for(var i=0;i<length;i++){errorTip=errors[i].errorMessage;break}$("#card_content_id .step-btn .error-message").removeClass("hide").html("<i class='tip-icon tip-error-16'></i>温馨提示："+errorTip)}},error:function(){cloudCart2Common.alertBox("保存用卡信息失败，请您稍后再试！")}})},function(){cloudCart2Common.cart2Logon()});e.preventDefault()})}},checkBind:function(cardNo,password){var message="";if(cardNo===""){message="温馨提示：请您输入卡号"}else{if(cardNo.length!=10&&cardNo.length!=14){message="温馨提示：请您输入正确的卡号"}else{if($(".gif-card-content").find("#"+cardNo).size()>0){message="您输入的卡号已存在，请勿重复添加"}}}if(message!==""){sendSaMessage("cardno",message);$("#card_content_id .add-gift-card-form div").addClass("error-row").find(".tip-message").removeClass("hide").html("<i class='tip-icon tip-error-16'></i>"+message);return false}if(password===""){message="温馨提示：请您输入密码"}else{if(password.length!==6){message="温馨提示：您输入的密码位数有误"}else{if(!checkInvalidChar(password)){message="温馨提示：您输入的密码有误"}}}if(message!==""){sendSaMessage("password",message);$("#card_content_id .add-gift-card-form div").addClass("error-row").find(".tip-message").removeClass("hide").html("<i class='tip-icon tip-error-16'></i>"+message);return false}sendSaMessage("cardno","");sendSaMessage("password","");return true},checkUseCard:function(authCode,cards){var errorTip="";var isUseCoupon=true;for(var i=0;i<cards.length;i++){if(!$(cards[i]).hasClass("not-auth-code")){isUseCoupon=false;break}}if(!isUseCoupon&&$("#authcode-input").length===0){errorTip="温馨提示：请您先绑定手机！若已绑定，请刷新重试！"}else{if(cards.length===0){errorTip="温馨提示：请您选择需要使用的苏宁卡"}else{if(cards.length>90){errorTip="温馨提示：您最多只能同时使用90张苏宁卡"}else{if(!isUseCoupon&&authCode.length!==6){errorTip="温馨提示：您输入的验证码位数有误";sendSaMessage("authcode-input",errorTip)}}}}if(errorTip!==""){$("#card_content_id .step-btn .error-message").removeClass("hide").html("<i class='tip-icon tip-error-16'></i>"+errorTip);return false}sendSaMessage("authcode-input","");return true}};var cloudCart2Mobile={init:function(){this.bindEvent.init()},bindEvent:{init:function(){this.initEditMobile();this.validateSave();this.removeMobile()},initEditMobile:function(){$("#step5").on("click","#other_coupon_content .modify-btn",function(){probeAuthStatus(function(){cloudCart2Mobile.editMobile("Y","N")},function(){cloudCart2Common.cart2Logon()})})},validateSave:function(){$("#step5").on("click","#add-union-phone-btn",function(){probeAuthStatus(function(){var alliancePhone=cloudCart2Common.getInputVal($("#alliancePhone_id"));if(alliancePhone==""){$("#mobile_error_id").html("<i class='tip-icon tip-error-16'></i>推荐号码不能为空，请核对后输入");$("#mobile_row_id").addClass("error-row");sendSaMessage("alliancePhone_id","推荐号码不能为空，请核对后输入");return}else{if(!checkMobile(alliancePhone)){$("#mobile_error_id").html("<i class='tip-icon tip-error-16'></i>您输入的手机号码有误，请核对后重新输入");$("#mobile_row_id").addClass("error-row");sendSaMessage("alliancePhone_id","您输入的手机号码有误，请核对后重新输入");return}}sendSaMessage("alliancePhone_id","");$.ajax({type:"post",url:"saveMobile.do",async:false,dataType:"json",data:{cart2No:$("#cart2No").val(),mobile:alliancePhone},success:function(data){if(data.returnCode=="4000"){cloudCart2Common.alertBox("您访问的太频繁， 网络拥堵，请您稍后再试！");return}if(data.isSuccess==="Y"){$("#other_coupon_content").html(data.mobileFinishHtml);$("#cmmdyTotalID").html(data.totalAmount);$("#shippingChargeID").html(data.transportFee);$("#cmmdyDiscountID").html(data.voucherTotalAmount);$("#payAmountID").html(data.payAmount);$("#energySubsidiesID").html(data.energySubsidiesAmount)}else{if(data.isSuccess="n-pass"){$("#mobile_error_id").html("<i class='tip-icon tip-error-16'></i>您输入的手机号不是推广联盟的手机号码，请核对后重新输入！");$("#mobile_row_id").addClass("error-row")}else{$("#mobile_error_id").html("<i class='tip-icon tip-error-16'></i>推荐号验证失败，请您稍后再试！");$("#mobile_row_id").addClass("error-row")}}},error:function(){cloudCart2Common.alertBox("推荐号验证失败，请您稍后再试！")}})},function(){cloudCart2Common.cart2Logon()})})},removeMobile:function(){$("#step5").on("click","#other_coupon_content .cancel-btn",function(){probeAuthStatus(function(){$.ajax({type:"post",url:"saveMobile.do",async:false,dataType:"json",data:{cart2No:$("#cart2No").val(),mobile:""},success:function(data){if(data.returnCode=="4000"){cloudCart2Common.alertBox("您访问的太频繁， 网络拥堵，请您稍后再试！");return}if(data.isSuccess==="Y"){cloudCart2Mobile.editMobile("Y","Y");$("#cmmdyTotalID").html(data.totalAmount);$("#shippingChargeID").html(data.transportFee);$("#cmmdyDiscountID").html(data.voucherTotalAmount);$("#couponAmountID").html(data.couponAmount);$("#cardAmountID").html(data.cardAmount);$("#payAmountID").html(data.payAmount);$("#energySubsidiesID").html(data.energySubsidiesAmount)}else{cloudCart2Common.alertBox("取消使用推荐号失败，请您稍后再试！")}},error:function(){cloudCart2Common.alertBox("取消使用推荐号失败，请您稍后再试！")}})},function(){cloudCart2Common.cart2Logon()})})}},editMobile:function(isEdit,isCancel){probeAuthStatus(function(){$.ajax({type:"post",url:"queryMobile.do",data:{cart2No:$("#cart2No").val(),isEdit:isEdit},dataType:"json",async:false,success:function(data){if(data.returnCode=="4000"){cloudCart2Common.alertBox("您访问的太频繁， 网络拥堵，请您稍后再试！");return}if(data.isSuccess==="Y"){$("#other_coupon_content").html(data.mobileFinishHtml);cloudCart.supportPlaceHolder.init("#other_coupon_content");if($("#other_coupon_title").hasClass("open")&&isEmpty(cloudCart2Common.getInputVal($("#alliancePhone_id")))&&isCancel=="N"){var queryAllianceInfoUrl="http://cart.suning.com/emall/queryAllianceInfoCmd";$.ajax({type:"get",url:queryAllianceInfoUrl,dataType:"jsonp",cache:false,success:function(data){var phoneNum=data.alliancePhone;if(!isEmpty(phoneNum)&&phoneNum!="null"){$("#alliancePhone_id").val(phoneNum)}},error:function(){}})}}else{cloudCart2Common.alertBox("推荐号信息加载失败，请您稍后再试！")}},error:function(){cloudCart2Common.alertBox("推荐号信息加载失败，请您稍后再试！")}})},function(){cloudCart2Common.cart2Logon()})}};var cloudCloudDiamond={saveCloudDiamondAmount:function(pointAccount,cart2No){var reg=/[^\d]/g;var result=reg.test(pointAccount);if(result){return}probeAuthStatus(function(){$.ajax({type:"post",url:"saveCloudDiamondAmount.do",async:false,dataType:"json",data:{pointAccount:pointAccount,cart2No:cart2No},success:function(data){if(data.returnCode=="4000"){cloudCart2Common.alertBox("您访问的太频繁， 网络拥堵，请您稍后再试！");return}else{if(data.result=="true"){if($("#card_content_id").find(".change").length>0){$("#card_content_id").html("");cloudCart2Card.showCard()}$("#toatalPiontsId").val(data.integralQuantity);$("#cloudAccountId").html(data.integralAmount);$("#cmmdyTotalID").html(data.totalAmount);$("#shippingChargeID").html(data.transportFee);$("#cmmdyDiscountID").html(data.voucherTotalAmount);$("#payAmountID").html(data.payAmount);$("#freeAmountID").html(data.couponAndCardAmount);$("#energySubsidiesID").html(data.energySubsidiesAmount)}else{if(data.result=="false"&&data.errCode=="004"){window.location.href="http://shopping.suning.com/error.do";return}else{cloudCart2Common.alertBox(data.errMsg)}}}},error:function(){cloudCart2Common.alertBox("小苏太忙，稍后再来试试")}})},function(){cloudCart2Common.cart2Logon()})},cleanCloudDiamond:function(){$(".checkout-promotion-input-item").find(".cart-checkbox").removeClass("cart-checkbox-checked");$("#cloudDaimondInputId").prop("checked",false);$(".diamond-check").hide();$("#toatalPiontsId").val("");$("#cloudAccountId").html("0.00")},fillingCloudDiamond:function(totalNum,totalAccount){$(".checkout-promotion-input-item").find(".cart-checkbox").addClass("cart-checkbox-checked");$("#cloudDaimondInputId").prop("checked",true);$(".diamond-check").show();$("#toatalPiontsId").val(totalNum);$("#cloudAccountId").html(totalAccount)}};