var regionInfo;var regionInfo1;var addressUtil={initSNAddress:function(){if($(".address-finish .addr:not(.add-addr)").length==0||$("#addressbox").attr("storepickup")=="Y"){var currentAddr=$("#addressbox");var addrInfo={cart2No:$("#cart2No").val(),optType:"",addressID:"",provinceName:currentAddr.attr("provname"),provinceCode:currentAddr.attr("provcode"),cityName:currentAddr.attr("cityname"),cityCode:currentAddr.attr("citycode"),districtName:currentAddr.attr("distname"),districtCode:currentAddr.attr("distcode")};if($("#addressbox").attr("storepickup")=="Y"){addrInfo.selectedSite=true;addrInfo.selfTakeShopCode=currentAddr.attr("selftakeshopcode")}if($(".address-finish .addr:not(.add-addr)").length==0){if($("#addressbox").attr("storepickup")=="Y"){$("#pickup_tab").find("input").trigger("click")}if(!$("#pickup_tab").hasClass("hide")){addressUtil.createSNAddress(addrInfo,true,false)}if(!$("#delivery_tab").hasClass("hide")){addressUtil.createSNAddress(addrInfo,false,false)}$("#set-default").siblings("label").find("i").addClass("l").siblings("span").addClass("l")}else{addressUtil.showAddrInput(addrInfo,false)}}},showAddrInput:function(addrInfo,isEdit){$.mLionDialog({css:{width:"800px"},title:isEdit?"修改配送信息":"新增配送信息",http:function(e,o){e.find(".content").html($("#addressbox").text());e.find(".container").css("overflow","visible");cloudCart.supportPlaceHolder.init(".m-lion-dialog")},overlayCss:{background:"black",opacity:"0.3"},fadeIn:300,fadeOut:300});if(!isEdit){if($(".address-finish .addr:not(.add-addr)[pickupaddress='true']").length>=5){$("#pickup_tab").addClass("hide")}else{if(addrInfo.selectedSite){$("#pickup_tab").find("input").trigger("click");$("#delivery_tab").addClass("hide")}}}else{if(addrInfo.optType=="3"){$("#delivery_tab").find("input").trigger("click");$("#pickup_tab").addClass("hide")}else{$("#pickup_tab").find("input").trigger("click");$("#delivery_tab").addClass("hide")}addressUtil.setEditInfo(addrInfo)}if(!$("#pickup_tab").hasClass("hide")){addressUtil.createSNAddress(addrInfo,true,isEdit)}if(!$("#delivery_tab").hasClass("hide")){addressUtil.createSNAddress(addrInfo,false,isEdit)}},setEditInfo:function(addrInfo){var formObj=addressUtil.isSelfPickUp()?$(".zt-address-form"):$(".sh-address-form");formObj.find(".user").val(addrInfo.receiverName).attr("data-is-enter",1);formObj.find(".user").css("color","#333");formObj.find(".mobile").val(addrInfo.receiverMobile);formObj.find(".area-number").val(addrInfo.receiverTelAreaCode);formObj.find(".tel-number").val(addrInfo.receiverTel);formObj.find(".ext-number").val(addrInfo.receiverTelExtNum);formObj.find(".detial-address").val(addrInfo.detailAddress).attr("data-is-enter",1);formObj.find(".detial-address").css("color","#333");if($("#overSeaFlag_ID").val()!="0"){addressUtil.setPostCode(addrInfo.cityCode.substring(5))}if($("#overSeaFlag_ID").val()=="1"||$("#footballProduct").val()=="true"){formObj.find(".card-id").val(addrInfo.idNumber)}var regionObj;if(!addressUtil.isSelfPickUp()){addressUtil.villageDelivery(addrInfo.smTownCode,addrInfo.townName);regionObj=$("#delivery_tab");regionObj.attr("townname",addrInfo.townName);regionObj.attr("towncode",addrInfo.townCode);regionObj.attr("townwcscode",addrInfo.townWCSCode);regionObj.attr("smtowncode",addrInfo.smTownCode);$(".sh-address-form").find(".detial-address").removeClass("verifica").removeAttr("disabled");if(addrInfo.defaultAddress=="true"){$("#set-default").prop("checked",true).closest(".cart-checkbox").addClass("cart-checkbox-checked");$("#set-default-tip").removeClass("hide")}}else{regionObj=$("#pickup_tab")}regionObj.attr("addressID",addrInfo.addressID);addressUtil.fixPlaceHolder(formObj);regionObj.attr("provname",addrInfo.provinceName);regionObj.attr("provcode",addrInfo.provinceCode);regionObj.attr("provwcscode",addrInfo.provWCSCode);regionObj.attr("cityname",addrInfo.cityName);regionObj.attr("citycode",addrInfo.cityCode);regionObj.attr("citywcscode",addrInfo.cityWCSCode);regionObj.attr("distname",addrInfo.districtName);regionObj.attr("distcode",addrInfo.districtCode);regionObj.attr("distwcscode",addrInfo.distWCSCode);regionObj.attr("deliveryregioncode",addrInfo.deliveryRegionCode)},fixPlaceHolder:function(formObj){formObj.find(".ui-text").each(function(){if(isEmpty($(this).val())||$(this).val()==$(this).attr("placetext")){if($(this).attr("data-is-enter")==1){$(this).css("color","#333")}else{$(this).val($(this).attr("placetext")).css("color","#bbb")}}else{$(this).css("color","#333")}})},createSNAddress:function(addressObj,isSelfPickUp,isEdit){var provname=addressObj.provinceName,cityname=addressObj.cityName,distname=addressObj.districtName,townname=addressObj.townName,provwcscode=addressObj.provWCSCode,citywcscode=addressObj.cityWCSCode,distwcscode=addressObj.distWCSCode,townwcscode=addressObj.townWCSCode,provcode=addressObj.provinceCode,citycode=addressObj.cityCode,distcode=addressObj.districtCode,towncode=addressObj.townCode;if(isSelfPickUp){var selfTakeShopCode=addressObj.selfTakeShopCode;regionInfo1=$("#city2").SnAddress({columns:[{state:"prov",text:"请选择省",hide:false,addclass:(isEmpty(provname)?"c-f70":"")},{state:"city",text:"请选择市",hide:false,addclass:(isEmpty(cityname)?"c-f70":"")},{state:"area",text:"请选择区",hide:false,addclass:(isEmpty(distname)?"c-f70":"")}],url:"http://cart.suning.com/emall/SNForCCFAddressCmd",complete:function(items,bool){if(!bool){$("#city2 .cityboxbtn span").removeClass()}addressUtil.setRegionInfo(items,true,selfTakeShopCode)}},[{name:provname,code:isEmpty(provwcscode)?"":provwcscode,id:provcode},{name:cityname,code:isEmpty(citywcscode)?"":citywcscode,id:citycode},{name:distname,code:isEmpty(distwcscode)?"":distwcscode,id:citycode+distcode}]).data("suning.address")}else{var addressColumns,addressDatas;if(!isEdit){addressColumns=[{state:"prov",text:"请选择省",hide:false,addclass:"c-f70"},{state:"city",text:"请选择市",hide:false,addclass:"c-f70"},{state:"area",text:"请选择区",hide:false,addclass:"c-f70"},{state:"town",text:"请选择乡镇",hide:false,addclass:"c-f70"}];addressDatas=[{name:"",code:"",id:""},{name:"",code:"",id:""},{name:"",code:"",id:""},{name:"",code:"",id:""}]}else{addressColumns=[{state:"prov",text:"请选择省",hide:false,addclass:(isEmpty(provname)?"c-f70":"")},{state:"city",text:"请选择市",hide:false,addclass:(isEmpty(cityname)?"c-f70":"")},{state:"area",text:"请选择区",hide:false,addclass:(isEmpty(distname)?"c-f70":"")},{state:"town",text:"请选择乡镇",hide:false,addclass:(isEmpty(townname)?"c-f70":"")}];addressDatas=[{name:provname,code:provwcscode,id:provcode},{name:cityname,code:citywcscode,id:citycode},{name:distname,code:distwcscode,id:citycode+distcode},{name:townname,code:townwcscode,id:towncode}]}regionInfo=$("#city").SnAddress({columns:addressColumns,url:"http://cart.suning.com/emall/SNForCCFAddressCmd",complete:function(items,bool){if(!bool){$("#city .cityboxbtn span").removeClass();addressUtil.setRegionInfo(items,false)}}},addressDatas).data("suning.address")}},setRegionInfo:function(items,isPickUp,selftakeshopcode){var obj;if(isPickUp){if(isEmpty(items[0].id)||items[0].id.length!=3||isEmpty(items[1].id)||items[1].id.length!=12||isEmpty(items[2].id)||items[2].id.length!=20){return}obj=$("#pickup_tab");if(!addressUtil.isEditBox()){obj.attr("tempdistwcscode",items[2].id.substring(18))}else{obj.attr("citywcscode",items[1].code);obj.attr("distwcscode",items[2].code)}obj.attr("provwcscode",items[0].id);addressUtil.sites.getSiteList($("#cart2No").val(),items[0].id,items[1].id,items[2].id.substring(12),$("#commodityType_ID").val()!=="0",addressUtil.sites.initSelector,selftakeshopcode)}else{addressUtil.villageDelivery(items[3].smTownCode,items[3].name);obj=$("#delivery_tab");if(!addressUtil.isEditBox()){obj.attr("citywcscode",items[3].code.substring(0,3));obj.attr("distwcscode",items[3].code.substring(0,5))}else{obj.attr("citywcscode",items[1].code);obj.attr("distwcscode",items[2].code)}obj.attr("provwcscode",items[0].id);obj.attr("townwcscode",items[3].code);obj.attr("townname",items[3].name);obj.attr("towncode",items[3].id);obj.attr("smtowncode",items[3].smTownCode);obj.attr("deliveryregioncode",items[3].code);$(".delivery-item-content").find(".detial-address").removeClass("verifica").removeAttr("disabled")}if($("#overSeaFlag_ID").val()!="0"){addressUtil.setPostCode(items[1].id.substring(5))}obj.attr("provname",items[0].name);obj.attr("provcode",items[0].id);obj.attr("cityname",items[1].name);obj.attr("citycode",items[1].id);obj.attr("distname",items[2].name);obj.attr("distcode",items[2].id.substring(12))},villageDelivery:function(smTownCode,townName){if(smTownCode==="0000000"){var msg="乡和村暂不提供送货上门服务，货到"+townName+"后工作人员会提前通知您取货";$("#village_tip").show().html("<i class='tip-icon tip-warning-16'></i>"+msg);$("#village_tip").closest(".row").next(".row").css({zoom:1})}else{$("#village_tip").html("")}},setPostCode:function(cityCode){$.ajax({url:"queryZipCode.do",data:{cityCode:cityCode},cache:true,dataType:"jsonp",success:function(data){var _postalCode=data.data;if($(".zt-address-form").length>0){$(".zt-address-form").find(".postalcode").val(_postalCode).css("color","#333")}if($(".sh-address-form").length>0){$(".sh-address-form").find(".postalcode").val(_postalCode).css("color","#333")}}})},isEditBox:function(){if($(".address-finish .addr:not(.add-addr)").length==0){return false}else{return $(".m-lion-dialog .title").find("h3").text().indexOf("新增")<0}},isSelfPickUp:function(){return $(".delivery-mode").find(".delivery-way-checked").attr("id")==="pickup_tab"},displayShowAll:function(){if(screen.width>=1200){if($(".addr-list").find("li").length<=5){$(".address-finish .show-all").hide()}else{$(".address-finish .show-all").show()}}else{if($(".addr-list").find("li").length<=4){$(".address-finish .show-all").hide()}else{$(".address-finish .show-all").show()}}},displayShow:function(){if($(".addr-selected").length>0){var index=$(".addr-selected").index();if(screen.width>=1200){if(index>=5){$(".address-finish .show-all").trigger("click")}}else{if(index>=4){$(".address-finish .show-all").trigger("click")}}}},deleteAddress:function(delAddr){var _parent=delAddr.parents(".addr"),_showAll=$(".address-finish .show-all");$.ajax({type:"post",url:"deleteAddress.do",data:{addressID:_parent.attr("id")},cache:false,dataType:"json",success:function(data){cloudCart2.address.unLock();if(data.returnCode==="Y"){delAddrFn(_parent,_showAll);$("#addressbox").attr("count",new Number($("#addressbox").attr("count"))-1)}else{if(data.returnCode==="4000"){cloudCart2Common.alertBox("您访问的太频繁， 网络拥堵，请您稍后再试！")}else{cloudCart2Common.alertBox("删除失败")}}}});function delAddrFn(_parent,_showAll){var rowNum;if(screen.width>=1200){rowNum=5}else{rowNum=4}var addrList=$(".addr-list").find("li:not('.add-addr')");if(addrList.length===2){addrList.find(".del").addClass("hide")}if(_showAll.length==0){_parent.animate({height:"0",width:"0",margin:"0",padding:"0",opacity:"0"},300,function(){_parent.remove();cloudCart2Common.checkSubmit();cloudCart2.address.initSelfApart();cloudCart2.address.addressLabel()})}else{_parent.animate({height:"0",width:"0",margin:"0",padding:"0",opacity:"0"},300,function(){_parent.remove();cloudCart2Common.checkSubmit();$(".addr-list .addr").eq(rowNum-1).removeClass("addr-self-top")});addressUtil.displayShowAll()}}},setDefaultAddr:function(setAddr){var _otherdefault=$(".address-finish .default-addr").not(setAddr);$.ajax({type:"post",url:"setDefaultAddr.do",data:{addressID:setAddr.parents("li").attr("id")},cache:false,dataType:"json",success:function(data){cloudCart2.address.unLock();if(data.returnCode==="Y"){_otherdefault.each(function(){$(this).parents("li").attr("defaultaddress","");$(this).parent().append('<a href="javascript:void(0);" class="set-default">设为默认</a>').end().remove()});setAddr.parents("li").attr("defaultaddress","true");setAddr.parent().append('<span class="default-addr c9">默认地址</span>').end().remove()}else{if(data.returnCode==="4000"){cloudCart2Common.alertBox("您访问的太频繁， 网络拥堵，请您稍后再试！")}else{cloudCart2Common.alertBox("设为默认地址失败")}}}})},changeCity:function(cityCode,distCode){$.ajax({url:"http://cart.suning.com/emall/SNCartChangeCityCmd",data:{newCityId:cityCode,newDistrictId:distCode,type:"02"},cache:false,dataType:"jsonp",jsonp:"callback",success:function(data){}})},confDeliInfo:function(addrInfo){$.ajax({type:"post",url:"confDeliInfo.do",data:addrInfo,cache:false,dataType:"json",success:function(data){if(data.returnCode=="4000"){cloudCart2Common.alertBox("您访问的太频繁， 网络拥堵，请您稍后再试！");$("#sava-addr-btn").removeClass("save-loading").addClass("cart-btn").html("保存");return}var savaResult=data.saveResult;var errors=savaResult.errorMsgList;var showTipFlag=false;var length=errors.length;var code="";if(length!==0){code=errors[0].errorCode;showTipFlag=(code==="202"||code==="206"||code==="207")}addressUtil.hideSenstiveInfo(addrInfo);if(savaResult.isSuccess==="Y"||showTipFlag){addressUtil.saveAddrSucceed(addrInfo,savaResult,showTipFlag,errors)}else{var selfPickup="0";if(addrInfo.optType=="1"||addrInfo.optType=="4"||addrInfo.optType=="5"){selfPickup="1"}addressUtil.saveAddrFali(errors,selfPickup)}cloudCart2.address.unLock()}})},saveAddrSucceed:function(addrInfo,savaResult,showTipFlag,errors){if(addrInfo.optType!="0"&&addrInfo.optType!="1"){if(addrInfo.optType=="2"||addrInfo.optType=="4"){addrInfo.addressID=savaResult.addressId}addressUtil.updateAddress(addrInfo);if($(".m-lion-dialog").length>0){$.unmLionDialog()}}if(addrInfo.optType=="2"||addrInfo.optType=="4"){var addrList=$(".addr-list").find("li:not('.add-addr')");if(addrList.length==2){addrList.find(".del").removeClass("hide")}var rowNum;if(screen.width>=1200){rowNum=5}else{rowNum=4}if($(".address-finish .show-all").length==0){cloudCart2.address.initSelfApart();cloudCart2.address.addressLabel()}$("#addressbox").attr("count",new Number($("#addressbox").attr("count"))+1)}if($(".address-finish .show-all").length==0){cloudCart2.address.initSelfApart();cloudCart2.address.addressLabel()}$("#"+addrInfo.addressID+"").addClass("addr-selected").siblings(".addr").removeClass("addr-selected");if(addrInfo.optType=="1"||addrInfo.optType=="4"||addrInfo.optType=="5"){$(".pickup-title:not(.not-support)").addClass("hide")}else{$(".pickup-title:not(.not-support)").removeClass("hide")}var oldDeliveryType=$("#deliveryType").val();$("#addressbox").attr("provcode",addrInfo.provinceCode).attr("citycode",addrInfo.cityCode).attr("distcode",addrInfo.districtCode).attr("provname",addrInfo.provinceName).attr("cityname",addrInfo.cityName).attr("distname",addrInfo.districtName);$("#deliveryType").val((addrInfo.optType==="0"||addrInfo.optType==="2"||addrInfo.optType==="3")?"1":"2");if(showTipFlag){var cmmdtyUrl,html,errorTip;for(var i=0;i<errors.length;i++){code=errors[i].errorCode;if(code==="206"){cloudCart2Common.alertBox("您订单中存在的商品价格发生变动，您是否继续购买？");$(".m-lion-dialog").find(".content .close").text("继续")}}}cloudCart2Payment.doModifyPayment(addrInfo.receiverMobile);var selfPickupType=addrInfo.selfPickupType;var selfTakeShopCode=addrInfo.selfTakeShopCode;var selfPickupCode=addrInfo.selfPickupCode;var scheme="N";if(selfPickupType=="01"&&selfTakeShopCode!=selfPickupCode){scheme="Y"}cloudCart2Cmmdty.deliveryClick($(":checked[name='choose-package-type']").get(0),scheme);var notEditInvoice=($("#finishDivInvoice").length===1)&&($("#step4").find("#modifyInvoice").length===0);if(!notEditInvoice){if(savaResult.invoiceAvailableFlag==="02"){cloudCart2Invoice.bindEven.doModifyInvoice("N")}else{if(savaResult.invoiceAvailableFlag==="00"){cloudCart2Invoice.bindEven.doModifyInvoice("Y")}else{if(savaResult.invoiceAvailableFlag==="01"){cloudCart2Invoice.bindEven.doModifyInvoice("Y")}}}}if(savaResult.citySwitchFlag==="1"){$("#step5 .toggle-title").removeClass("open");$("#coupon_finish_id").html("").hide();$("#card_content_id").html("");$("#step5 #card_content_id").hide();cloudCloudDiamond.cleanCloudDiamond()}var orderAddr=$("#step6 .order-address span");var receiveInfo=addrInfo.receiverName+" "+addrInfo.receiverMobile+" "+addrInfo.provinceName+addrInfo.cityName+addrInfo.districtName+addrInfo.townName+addrInfo.detailAddress;$(orderAddr.get(0)).attr("title",receiveInfo).html(receiveInfo);$("#cmmdyTotalID").html(savaResult.totalAmount);$("#shippingChargeID").html(savaResult.transportFee);$("#cmmdyDiscountID").html(savaResult.voucherTotalAmount);$("#freeAmountID").html(savaResult.freeUsingAmount);$("#payAmountID").html(savaResult.payAmount);$("#energySubsidiesID").html(savaResult.energySubsidiesAmount);$("#toatalPiontsId").val(savaResult.integralQuantity);$("#cloudAccountId").html(savaResult.integralAmount);cloudCart2Common.checkSubmit();addressUtil.changeCity(addrInfo.deliveryRegionCode.substring(0,3),addrInfo.districtCode.substring(6));if($("#finish_coupon_page").length===0&&oldDeliveryType!=$("#deliveryType").val()&&$(".bookingCart").length==0){cloudCart2Coupon.bindEvent.editCoupon(false)}},saveAddrFali:function(errors,selfPickup){var code="",errorTip="",html="",cmmdtyUrl="",lihtml="",cmmdtyName="",imgUrl="",needAlert=($(".m-lion-dialog").length>0)?"N":"Y",flag=($(".m-lion-dialog").length>0);if($("#directFlag").val()==="1"){cmmdtyUrl=$("#step3").find(".product-name a")[0].href}for(var i=0;i<errors.length;i++){if(code==""){code=errors[0].errorCode}if(code!=""&&code!=errors[i].errorCode){continue}appendInput("Saveaddress");sendSaMessage("Saveaddress",errors[i].errorMessage+"CODE:"+code+",USER:"+getCookie("custno"));if(code==="004"){window.location.href="http://shopping.suning.com/error.do";return}else{if(code==="001"){errorTip="请重新确认配送地址";if(selfPickup=="1"){errorTip="该自提点不可用，请重新选择！"}}else{if(code==="203"){errorTip="请检查收货人信息及城市信息填写是否正确"}else{errorTip=errors[i].errorMessage;if(code==="075"){needAlert="Y";cmmdtyUrl=$("#"+$("#"+errors[i].itemNo).attr("mianid")).attr("href");cmmdtyName=$("#"+errors[i].itemNo).attr("title").split("x")[0];if(isEmpty(cmmdtyName)){cmmdtyName="赠品"}if(errors[i].errorMessage==="0"){lihtml+="<li><span class='has-over r'>已赠完</span><span class='pre-first bg-over'>赠品</span><span class='present-name fcl' title='"+cmmdtyName+"'>"+cmmdtyName+"</span></li>"}else{lihtml+="<li><span class='remain r'>剩余"+errors[i].errorMessage+"件</span><span class='pre-first'>赠品</span><span class='present-name fcl' title='"+cmmdtyName+"'>"+cmmdtyName+"</span></li>"}continue}else{if(code==="076"){needAlert="Y";cmmdtyName=$("#"+errors[i].itemNo).html();if(isEmpty(cmmdtyName)){cmmdtyName="赠品"}cmmdtyUrl=$("#"+errors[i].itemNo).attr("href");lihtml+="<li><span class='fcl' title='"+cmmdtyName+"'>"+cmmdtyName+"</span></li>";continue}else{if(needAlert=="Y"){if(code=="002"||code=="005"||code=="006"||code=="007"||code=="064"){cmmdtyName=$("#"+errors[i].itemNo).html();if(isEmpty(cmmdtyName)){code="noCmmdtyName";break}var item=$("#"+errors[i].itemNo).parents(".product-detail").siblings("a").find("img");if(item.attr("lazy-src")){imgUrl=item.attr("lazy-src")}else{imgUrl=item.attr("src")}var imgMsg="";if(code=="005"){imgMsg='<div class="service-warming-product-img-box" title="'+cmmdtyName+'"></div>'}else{imgMsg='<img src="'+imgUrl+'" alt="'+cmmdtyName+'" title="'+cmmdtyName+'">'}lihtml+='<li class="list">'+imgMsg+"</li>";continue}}}}}}}}if(isEmpty(errorTip)){errorTip="请重新确认配送地址";if(selfPickup=="1"){errorTip="该自提点不可用，请重新选择！"}}if(!flag){$("#sava-addr-btn").removeClass("save-loading").addClass("cart-btn").html("保存")}if(needAlert==="Y"){if($(".m-lion-dialog").length>0){$.unmLionDialog()}cloudCart2Submit.alertErrortip(code,errorTip,lihtml,cmmdtyUrl,false)}else{$("#sava-addr-btn").removeClass("save-loading").addClass("cart-btn").html("保存");$(".save-addr-error").removeClass("hide").html('<i class="tip-icon tip-error"></i>'+errorTip)}},hideSenstiveInfo:function(addressInfo){var firstStr,secondStr,thirdStr;var recMobile=addressInfo.receiverMobile;if(!isEmpty(recMobile)&&recMobile.indexOf("*")<0){firstStr=recMobile.substring(0,3);secondStr="****";thirdStr=recMobile.substring(recMobile.length-4);addressInfo.receiverMobile=(firstStr+secondStr+thirdStr)}var recTel=addressInfo.receiverTel;if(!isEmpty(recTel)&&recTel.indexOf("*")<0){firstStr=recTel.substring(0,recTel.length-4);addressInfo.receiverTel=(firstStr+"****")}var extNum=addressInfo.receiverTelExtNum;if(!isEmpty(extNum)&&extNum.indexOf("*")<0){addressInfo.receiverTelExtNum=extNum.replace(/./g,"*")}var idNumber=addressInfo.idNumber;if(!isEmpty(idNumber)&&idNumber.indexOf("*")<0){firstStr=idNumber.substring(0,1);secondStr=idNumber.substring(1,idNumber.length-1).replace(/./g,"*");thirdStr=idNumber.substring(idNumber.length-1);addressInfo.idNumber=(firstStr+secondStr+thirdStr)}},updateAddress:function(addressInfo){if(addressInfo.optType==="2"||addressInfo.optType==="4"){var addrLiHtml='<li class="addr addr-selected" id="'+addressInfo.addressID+'"><div class="inner"><div class="addr-hd"><span class="name fl"></span><span class="addr-desc fr"><span class="prov"></span>&nbsp;<span class="city"></span></span></div><div class="addr-bd" title=""><span class="dist"></span>&nbsp;<span class="town"></span>&nbsp;<span class="street"></span>&nbsp;<span class="phone"></span></div><div class="addr-toolbar">'+(($("#overSeaFlag_ID").val()=="1"||$("#footballProduct").val()=="true")?'<span class="name-flag fl c9">'+addressInfo.idNumber+"</span>":"")+'<span class="addr-opt fr"><a href="javascript:void(0);" class="modify-addr" name="new_icart2_add_change">修改</a>'+(addressInfo.optType!="4"?'<a href="javascript:void(0);" class="set-default">设为默认</a>':"")+'</span></div></div><a class="del" name="new_icart2_add_delete"></a><a class="selected"></a>'+(addressInfo.optType=="4"?'<span class="addr-flag"></span>':"")+"</li>";if($(".address-finish .addr:not(.add-addr)").length==0){$("#step1").removeClass().find(".address-container").removeClass("new-user").addClass("address-finish").find(".edit").removeClass("hide");var html='<div class="addr-list clearfix"><ul>'+addrLiHtml+'<li class="addr add-addr" name="new_icart2_add_addnew01"><div class="inner"><p class="add-addr-text">添加地址</p></div></li></ul></div>';$("#step1").find(".nearby-self-pickup").removeClass("hide").siblings("div").remove();$("#step1").find(".nearby-self-pickup").before(html);$(".addr-list").find("li").find(".del").addClass("hide")}else{$(".addr-list").find("ul").prepend(addrLiHtml);$($(".addr-list").find("li")[0]).find(".del").removeClass("hide");addressUtil.displayShowAll()}}else{if($("#overSeaFlag_ID").val()=="1"||$("#footballProduct").val()=="true"){$("#"+addressInfo.addressID).find(".inner .name-flag").text(addressInfo.idNumber)}}var addrLiObj=$("#"+addressInfo.addressID);var addrDisplayObj=addrLiObj.find(".inner");addrDisplayObj.find(".name").text(addressInfo.receiverName);addrDisplayObj.find(".prov").text(addressInfo.provinceName);addrDisplayObj.find(".city").text(addressInfo.cityName);addrDisplayObj.find(".dist").text(addressInfo.districtName);addrDisplayObj.find(".phone").text(addressInfo.receiverMobile);addrLiObj.attr("provcode",addressInfo.provinceCode);addrLiObj.attr("citycode",addressInfo.cityCode);addrLiObj.attr("distcode",addressInfo.districtCode);addrLiObj.attr("provwcscode",addressInfo.provWCSCode);addrLiObj.attr("citywcscode",addressInfo.cityWCSCode);addrLiObj.attr("distwcscode",addressInfo.distWCSCode);addrLiObj.attr("provname",addressInfo.provinceName);addrLiObj.attr("cityname",addressInfo.cityName);addrLiObj.attr("distname",addressInfo.districtName);addrLiObj.attr("areacode",addressInfo.receiverTelAreaCode);addrLiObj.attr("telephone",addressInfo.receiverTel);addrLiObj.attr("extnum",addressInfo.receiverTelExtNum);addrLiObj.attr("deliveryRegionCode",addressInfo.deliveryRegionCode);addrLiObj.attr("postalCode",addressInfo.postalCode);addrLiObj.attr("idnumber",addressInfo.idNumber);addrLiObj.attr("receivername",addressInfo.receiverName);addrLiObj.attr("receivermobile",addressInfo.receiverMobile);var defaultAddr=$(".addr-list").find("li[defaultaddress='true']");if(addressInfo.optType=="1"||addressInfo.optType=="4"||addressInfo.optType=="5"){var displayStreet=addressInfo.townName+"（"+addressInfo.detailAddress+"）";addrDisplayObj.find(".addr-bd").attr("title",addressInfo.districtName+displayStreet);addrDisplayObj.find(".street").text(addressUtil.getStreet(addressInfo.districtName,"",displayStreet));addrLiObj.attr("selfTakeShopCode",addressInfo.selfTakeShopCode);addrLiObj.attr("selfPickupCode",addressInfo.selfPickupCode);addrLiObj.attr("selfPickupType",addressInfo.selfPickupType);addrLiObj.attr("pickupAddress","true");if(defaultAddr.length>0){if(defaultAddr.attr("id")!=addressInfo.addressID){defaultAddr.after(addrLiObj)}}else{$(".addr-list").find("ul").prepend(addrLiObj.remove())}}else{addrDisplayObj.find(".town").text(addressInfo.townName);addrDisplayObj.find(".street").text(addressUtil.getStreet(addressInfo.districtName,addressInfo.townName,addressInfo.detailAddress));addrDisplayObj.find(".addr-bd").attr("title",addressInfo.districtName+addressInfo.townName+addressInfo.detailAddress);addrLiObj.attr("townwcscode",addressInfo.townWCSCode);addrLiObj.attr("towncode",addressInfo.townCode);addrLiObj.attr("townname",addressInfo.townName);addrLiObj.attr("detailaddr",addressInfo.detailAddress);addrLiObj.attr("smtowncode",addressInfo.smTownCode);addrLiObj.attr("pickupAddress","");if(addressInfo.defaultAddress){defaultAddr.attr("defaultAddress","");addrLiObj.attr("defaultAddress","true");if(defaultAddr.attr("id")!=addressInfo.addressID){defaultAddr.find(".addr-opt").append('<a href="javascript:void(0);" class="set-default">设为默认</a>').find(".default-addr").remove();addrLiObj.find(".addr-opt").append('<span class="default-addr c9">默认地址</span>').find(".set-default").remove();$(".addr-list").find("ul").prepend(addrLiObj.remove())}}else{if(defaultAddr.attr("id")==addressInfo.addressID){addrLiObj.find(".addr-opt").append('<a href="javascript:void(0);" class="set-default">设为默认</a>').find(".default-addr").remove()}addrLiObj.attr("defaultAddress","");if(defaultAddr.length>0){if(defaultAddr.attr("id")!=addressInfo.addressID){defaultAddr.after(addrLiObj)}}else{$(".addr-list").find("ul").prepend(addrLiObj.remove())}}}},getStreet:function(districtName,townName,detailAddress){var countLimit=23;var detailNew=detailAddress;var districtLength=districtName.length;var townLength=townName.length;var detailLength=detailAddress.length;var wordLength=districtLength+townLength+detailLength;if(wordLength>countLimit){detailNew=detailAddress.substring(0,countLimit-districtLength-townLength-1)+"..."}return detailNew},sites:{getSiteList:function(cart2No,provinceId,cityId,distId,hasCShop,callBackFn,selectedValue){var pickupCabList;$.ajax({type:"post",url:"queryPickupCab.do",data:{cart2No:cart2No,provinceId:provinceId,cityId:cityId,regionId:distId},cache:false,dataType:"json",success:function(returnData){pickupCabList=returnData.pickupCabList}});var key=cityId+distId;var result=$("body").data(key);var _this=this;if(isEmpty(result)){$.ajax({url:"http://cart.suning.com/emall/SNForCCFAddressCmd",data:{state:"sites",selectId:key},cache:false,dataType:"jsonp",jsonp:"callback",success:function(returnData){$("body").data(key,returnData);var timerId=setInterval(function(){if(pickupCabList){clearInterval(timerId);callBackFn(addressUtil.sites.createSiteList(pickupCabList,returnData,hasCShop),selectedValue)}},20)}})}else{var timerId=setInterval(function(){if(pickupCabList){clearInterval(timerId);callBackFn(addressUtil.sites.createSiteList(pickupCabList,result,hasCShop),selectedValue)}},10)}},createSiteList:function(pickupCabList,result,hasCShop){var siteList=[];if(!isEmpty(result)&&!isEmpty(result.data)&&"exception"!=result.data){var tempList=result.data;if(hasCShop){tempList=addressUtil.sites.getListForC(tempList)}var siteLength=tempList.length,siteInfos,site,resStatus;for(var i=0;i<siteLength;i++){site=tempList[i];siteInfos=site.code.split("_");site.regionCode=siteInfos[0];site.selfPickupCode=siteInfos[1];site.siteType=siteInfos[2];site.detailAddr=siteInfos[3];resStatus="";if(site.siteType==="6"){for(var j=0;j<pickupCabList.length;j++){if(site.selfPickupCode===pickupCabList[j].pickupStoreId){resStatus=pickupCabList[j].resStatus;break}}if(isEmpty(resStatus)){continue}else{site.resStatus=resStatus;siteList.push(site)}}else{siteList.push(site)}}}return siteList},getListForC:function(siteList){var siteLength=siteList.length;var sitesForC=[];var site;for(var i=0;i<siteLength;i++){site=siteList[i];if(site.cPickupSite==="01"){sitesForC.push(site)}}return sitesForC},initSelector:function(siteList,selectedValue){if(isEmpty(siteList)){$("#pickUp").addClass("hide").html("");$("#sites_tip").removeClass("hide").text("您选择的自提地址没有可支持该订单的自提点，请重新选择！")}else{var siteCount=siteList.length,storeSites="",convenienceStoreSites="",schoolSites="",boxSites="",siteDesc,siteType,liHtml="",ulHtml="",site;for(var i=0;i<siteCount;i++){site=siteList[i];siteDesc=site.name+"（"+site.detailAddr+"）";siteType=site.siteType;liHtml="<li class='"+(site.resStatus=="02"?"full-disable":"clearfix")+"'><div class='cart-radio'><input type='radio' name='site_adress' class='radio-box site-radio' id='self"+i+"' value='"+site.id+"' "+(site.resStatus==="02"?" disabled='disabled'":"")+"detail='"+siteDesc+"' siteType='"+siteType+"' deliveryregioncode='"+site.regionCode+"' selfpickupcode='"+site.selfPickupCode+"' resStatus='"+site.resStatus+"'><label for='self"+i+"'></label></div>"+(site.resStatus=="02"?"<span>"+siteDesc+"<span class='full'>(已满)</span></span>":"<span class='l'>"+siteDesc+"</span>")+"</li>";if(siteType==="5"){schoolSites+=liHtml}else{if(siteType==="6"){boxSites+=liHtml}else{if(siteType==="7"){convenienceStoreSites+=liHtml}else{storeSites+=liHtml}}}}ulHtml="<ul>"+storeSites+schoolSites+convenienceStoreSites+boxSites+"</ul>";$("#pickUp").removeClass("hide").html(ulHtml);$("#sites_tip").addClass("hide").text("");clearTipMsg($("#city2"));if(isEmpty(selectedValue)){if(siteCount==1){selectedValue=siteList[0].id}}if(!isEmpty(selectedValue)){var selectedObj=$("#pickUp").find("input[value='"+selectedValue+"']");selectedObj.trigger("click");if(selectedObj.attr("resStatus")=="02"){showError($("#city2"),"此自提柜已满，请选择其他自提柜")}else{cloudCart2.address.selfPickScroll($(".delivery-mode"))}}}},selectSite:function(){var selectedSite=$("#pickUp").find("li.selected").find("input");var ztObj=$("#pickup_tab");ztObj.attr("selftakeshopcode",selectedSite.val());ztObj.attr("selfPickupCode",selectedSite.attr("selfpickupcode"));ztObj.attr("selfpickuptype",selectedSite.attr("siteType")=="6"?"02":"01");ztObj.attr("deliveryRegionCode",selectedSite.attr("deliveryregioncode"));ztObj.attr("towncode",selectedSite.attr("deliveryregioncode").substring(5));var detail=selectedSite.attr("detail");var detailIndex=selectedSite.attr("detail").lastIndexOf("（");var sitename="";var detailaddress="";if(detailIndex>0){sitename=detail.substring(0,detailIndex);detailaddress=detail.substring(detailIndex+1,detail.length-1)}ztObj.attr("townname",sitename);ztObj.attr("detailaddress",detailaddress);if(!addressUtil.isEditBox()){var cityWCSCode=selectedSite.attr("deliveryregioncode").substring(0,3);ztObj.attr("citywcscode",cityWCSCode);ztObj.attr("distwcscode",cityWCSCode+ztObj.attr("tempdistwcscode"))}clearTipMsg($("#city2"))}}};