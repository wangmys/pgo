var ECode=ECode||{};ECode.cartCalendar=function(options){var aryDay=new Array("周日","周一","周二","周三","周四","周五","周六");var timeSection=new Array("白天","上午","下午","晚上");var input=$(".m-date-input");function formatNum(num){return num.toString().replace(/^(\d)$/,"0$1")}function delzero(num){return num.toString().charAt(0)=="0"?num.substring(1,2):num}function formatStrDate(vArg){switch(typeof vArg){case"string":vArg=vArg.split(/-|\//g);return vArg[0]+"-"+formatNum(vArg[1])+"-"+formatNum(vArg[2]);break;case"object":return vArg.getFullYear()+"-"+formatNum(vArg.getMonth()+1)+"-"+formatNum(vArg.getDate());break}}function formatIntDate(sDate){return formatStrDate(sDate).replace(/-|\//g,"")}cartCalendarFn={init:function(){var _that=this;input.each(function(){var $this=$(this);_that._initValue($this);$this.bind("click",function(e){e.stopPropagation();$(".cart-calendar-box").remove();$(".m-date-input").removeClass("on");$this.addClass("on");$this.blur();var selectDate=$this.attr("selectdate");var unshipDate=$this.attr("disabledate");var startDate=$this.attr("startdate");_that._createContainer($this);_that.createDateType($this);_that.outClick($this)})})},_initValue:function(o){var type=o.attr("datetype");switch(type){case"1":o.hasClass("ship-date")&&o.val("工作日为您送达");break;case"2":o.hasClass("ship-date")&&o.val("休息日为您送达");break;case"3":var _sDate=o.attr("selectdate").replace(/-0/g,"-");var _arrDate=_sDate.split(/-|\//g);var _sDate2=new Date(_arrDate[0],_arrDate[1]-1,_arrDate[2]);var _year=_sDate2.getFullYear();var _month=delzero(_sDate2.getMonth()+1);var _date=delzero(_sDate2.getDate());var _day=_sDate2.getDay();var _fulldate=_year+"-"+_month+"-"+_date+aryDay[_day]+" ";var _selectdate=o.attr("selectdate");switch(_arrDate[3]){case"1":_fulldate+=timeSection[0];break;case"2":_fulldate+=timeSection[1];break;case"3":_fulldate+=timeSection[2];break;case"4":_fulldate+=timeSection[3];break;default:_fulldate+=timeSection[0]}o.val(_fulldate);o.attr("week",aryDay[_day]);if(o.parents("td").hasClass("ship-install-sync")){var td=o.parents("td");var tr=td.parent();var rowspan=parseInt(td.attr("rowspan"));var $tr=tr.nextAll(":lt("+(rowspan-1)+")").andSelf();$tr.find(".install-date, .ship-date").attr("date-group",$tr.first().index());$tr.each(function(){var _that=$(this);var allSync=_that.find(".ship-install-sync");if(allSync.length==0){return}var installDate=allSync.find(".install-date");installDate.val(_fulldate);installDate.attr("week",aryDay[_day]);installDate.attr("selectdate",_selectdate)})}break;case"4":var msg="急速达（"+(o.attr("fastDeliveryNum")||2)+"小时送达）";o.hasClass("ship-date")&&o.val(msg);break;case"6":var dateGroup=o.attr("date-group");var _input=$(".ship-date[date-group="+dateGroup+"]");if(_input.length==0){break}var _week=_input.attr("week");var _dateSelect=_input.attr("selectdate").replace(/-0/g,"-").split(/-|\//g);var _frontDate=new Date(_dateSelect[0],_dateSelect[1]-1,_dateSelect[2]);var _dateYeart=_frontDate.getFullYear();var _dateMonth=_dateSelect[1];var _dateDay=_dateSelect[2];var _fullDate=_dateYeart+"-"+_dateMonth+"-"+_dateDay+" "+_week;switch(_dateSelect[3]){case"1":_fullDate+=timeSection[0];break;case"2":_fullDate+=timeSection[1];break;case"3":_fullDate+=timeSection[2];break;case"4":_fullDate+=timeSection[3];break;default:_fullDate+=timeSection[0]}o.val(_fullDate);o.attr("week",_week);break}},_createContainer:function(input){var inputPos=input.offset();var container=this.container=$("<div class='cart-calendar-box'></div>");container.css({left:inputPos.left+input.outerWidth()-574,top:inputPos.top+input.outerHeight()-2});container.bind("click",function(e){e.stopPropagation()});container.append($("<div class='package_time clearfix'></div>"));$("body").append(container)},createDateType:function(input){var type=input.attr("datetype");if(input.hasClass("ship-date")){if(input.attr("isSwitchDateType")=="true"&&input.attr("isFastDelivery")=="true"){this.container.prepend(this.tempDateType._shiptype3(input.attr("fastDeliveryNum")))}else{if(input.attr("isSwitchDateType")=="false"&&input.attr("isFastDelivery")=="true"){this.container.prepend(this.tempDateType._shiptype4(input.attr("fastDeliveryNum")))}else{if(input.attr("isSwitchDateType")=="true"&&input.attr("isFastDelivery")=="false"){this.container.prepend(this.tempDateType._shiptype1)}else{this.container.prepend(this.tempDateType._shiptype2)}}}}else{if(input.hasClass("install-date")){if(input.attr("isWholeType")=="true"){this.container.prepend(this.tempDateType._deliverinstallType)}else{this.container.prepend(this.tempDateType._installtype)}}}switch(type){case"1":$(".work-day",".cart-calendar-box").parent("li").addClass("current");$(".cart-calendar-box .package_time").html(this.tempDateTypeContent.workday);break;case"2":$(".day-off",".cart-calendar-box").parent("li").addClass("current");$(".cart-calendar-box .package_time").html(this.tempDateTypeContent.dayoff);break;case"3":$(".day-detial",".cart-calendar-box").parent("li").addClass("current");this._create(input);this._drawDate(input);break;case"4":$(".fast-delivery",".cart-calendar-box").parent("li").addClass("current");$(".cart-calendar-box .package_time").html(this.tempDateTypeContent.fastDelivery(input.attr("fastDeliveryNum")));break;case"6":var selectFlag=input.attr("isselectdetail");if(selectFlag=="false"){$(".day-sync",".cart-calendar-box").parent("li").addClass("current");$(".cart-calendar-box .package_time").html(this.tempDateTypeContent.daysync);break}else{$(".day-detial",".cart-calendar-box").parent("li").addClass("current");this._create(input);this._drawDate(input);break}}this.bindDatetypeEvent(input)},bindDatetypeEvent:function(input){var that=this;$(".cart-calendar-box .date-type-box li").click(function(e){$(this).addClass("current").siblings().removeClass("current");if($(this).find("a").hasClass("work-day")){input.attr("datetype","1");$(".cart-calendar-box .package_time").html(that.tempDateTypeContent.workday);that._initValue(input)}if($(this).find("a").hasClass("day-off")){input.attr("datetype","2");$(".cart-calendar-box .package_time").html(that.tempDateTypeContent.dayoff);that._initValue(input)}if($(this).find("a").hasClass("day-sync")){input.attr("datetype","6");input.attr("isselectdetail","false");$(".cart-calendar-box .package_time").html(that.tempDateTypeContent.daysync);that._initValue(input);input.change()}if($(this).find("a").hasClass("day-detial")){if(!input.parents("td").hasClass("ship-install-sync")){input.attr("datetype","3")}$(".cart-calendar-box .package_time").empty();that._create(input);that._drawDate(input);that._initValue(input)}if($(this).find("a").hasClass("fast-delivery")){input.attr("datetype","4");$(".cart-calendar-box .package_time").html(that.tempDateTypeContent.fastDelivery(input.attr("fastDeliveryNum")));that._initValue(input);input.change()}})},_drawDate:function(input){var selectDate=input.attr("selectdate").replace(/-0/g,"-");var unshipDate=input.attr("disabledate")?input.attr("disabledate").replace(/-0/g,"-"):"";var startDate=input.attr("startdate").replace(/-0/g,"-");var sdate=startDate.split(/-|\//g);var sdate2=new Date(sdate[0],sdate[1]-1,sdate[2]);var rdate=selectDate.split(/-|\//g);var undate=unshipDate.split(/,/g);var undateLen=undate.length;var temp_item=[];var item_select=$(".item_select");for(var i=0;i<8;i++){temp_item.push("<ul>");var temp_date=new Date(sdate[0],parseInt(sdate[1])-1,parseInt(sdate[2])+i);var _year=temp_date.getFullYear();var _month=delzero(temp_date.getMonth()+1);var _date=delzero(temp_date.getDate());var _day=temp_date.getDay();var _fulldate=_year+"-"+_month+"-"+_date;var _fulltime1=_year+"-"+_month+"-"+_date+"-1";var _fulltime2=_year+"-"+_month+"-"+_date+"-2";var _fulltime3=_year+"-"+_month+"-"+_date+"-3";var _fulltime4=_year+"-"+_month+"-"+_date+"-4";var _fulltime5=_year+"-"+_month+"-"+_date;var classname1="",classname2="",classname3="",classname4="";var _title1="",_title2="",_title3="",_title4;var _time=["白天9:00-18:00","上午9:00-14:00","下午14:00-18:00","晚上18:00-22:00"];var _disableDate=0,_disableDate2=0;if(_day==6||_day==0){temp_item.push('<li class="top weekend">')}else{temp_item.push('<li class="top">')}temp_item.push(aryDay[_day]+"<br />"+_month+"/"+_date+"</li>");if(_day==6||_day==0){classname1+="weekend ";classname2+="weekend ";classname3+="weekend ";classname4+="weekend "}if(input.attr("isDateSection")=="true"){var reg1=eval("/"+_fulltime1+"/");var reg2=eval("/"+_fulltime2+"/");var reg3=eval("/"+_fulltime3+"/");var reg4=eval("/"+_fulltime4+"/");var reg5=eval("/\\b"+_fulltime5+"\\b/");_title1=_fulldate+" "+aryDay[_day]+" "+_time[0];_title2=_fulldate+" "+aryDay[_day]+" "+_time[1];_title3=_fulldate+" "+aryDay[_day]+" "+_time[2];_title4=_fulldate+" "+aryDay[_day]+" "+_time[3];if(reg1.test(unshipDate)){classname1+="disabled ";_title1="该时段不可选";_disableDate=1}if(reg2.test(unshipDate)){classname2+="disabled ";_title2="该时段不可选";_disableDate=1;_disableDate2=1}if(reg3.test(unshipDate)){classname3+="disabled ";_title3="该时段不可选";_disableDate=1;_disableDate2=1}if(!!_disableDate2){classname1+="disabled ";_title1="该时段不可选";_disableDate=1}if(reg4.test(unshipDate)){classname4+="disabled ";_title4="该时段不可选";_disableDate=1}if(!!_disableDate){}else{if(reg5.test(unshipDate)){classname1+="disabled ";_title1="该时段不可选";classname2+="disabled ";_title2="该时段不可选";classname3+="disabled ";_title3="该时段不可选";classname4+="disabled ";_title4="该时段不可选"}}if(reg1.test(selectDate)){classname1+="selected "}else{if(reg2.test(selectDate)){classname2+="selected "}else{if(reg3.test(selectDate)){classname3+="selected "}else{if(reg4.test(selectDate)){classname4+="selected "}}}}temp_item.push('<li class="'+classname2+'"><a time="2" week="'+aryDay[_day]+'" date="'+_fulltime2+'" date2="'+_fulldate+'" title="'+_title2+'" href="javascript:;"><i class="dot"></i></a></li>');temp_item.push('<li class="'+classname3+'"><a time="3" week="'+aryDay[_day]+'" date="'+_fulltime3+'" date2="'+_fulldate+'" title="'+_title3+'" href="javascript:;"><i class="dot"></i></a></li>');if(input.attr("isNight")=="true"){temp_item.push('<li class="'+classname4+'"><a time="4" week="'+aryDay[_day]+'" date="'+_fulltime4+'" date2="'+_fulldate+'" title="'+_title4+'" href="javascript:;"><i class="dot"></i></a></li>')}}else{var reg1=eval("/"+_fulltime5+"/");var reg3=eval("/"+_fulltime5+"/");if(reg3.test(unshipDate)){classname1="disabled";_title1="该时段不可选"}if(reg1.test(selectDate)){classname1="selected"}temp_item.push('<li class="'+classname1+'"><a time="'+1+'" week="'+aryDay[_day]+'" date2="'+_fulldate+'" date="'+_fulltime1+'" title="'+_title1+'" href="javascript:;"><i class="dot"></i></a></li>')}temp_item.push("</ul>")}item_select.html($(temp_item.join("")));$(".item_select li:not(.top)").hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")});this._linkOn(input);this.outClick(input)},_create:function(input){var _temp1;var isDateSection=input.attr("isDateSection");var isNight=input.attr("isNight");if(isDateSection=="true"&&isNight!="true"){_temp=this._tempHeader[2].join("")}else{if(isDateSection=="true"&&isNight=="true"){_temp=this._tempHeader[3].join("")}else{_temp=this._tempHeader[1].join("")}}this.container.find(".package_time").append(_temp)},_linkOn:function(input){var that=this;var links=this.container.find(".package_time li").not(".disabled").find("a");links.each(function(){$(this).click(function(){$(this).parents(".item_select").find(".selected").removeClass("selected");$(this).parent("li").addClass("selected");var _strdate=$(this).attr("date2")+$(this).attr("week")+" "+timeSection[$(this).attr("time")-1];var _selectdate=$(this).attr("date");input.val(_strdate);input.attr("selectdate",_selectdate);input.attr("week",$(this).attr("week"));var syncFlag=input.parents("td").hasClass("ship-install-sync");if(syncFlag&&input.hasClass("install-date")){input.attr("isselectdetail","true");input.attr("datetype","3")}if(syncFlag&&input.hasClass("ship-date")){var td=input.parents("td");var tr=td.parent();var rowspan=parseInt(td.attr("rowspan"));var $tr=tr.nextAll(":lt("+(rowspan-1)+")").andSelf();$tr.each(function(){var _that=$(this);var allSync=_that.find(".ship-install-sync");if(allSync.length==0){return}var installDate=allSync.find(".install-date");installDate.val(_strdate);installDate.attr("isselectdetail","false");installDate.attr("week",$(this).attr("week"));installDate.attr("selectdate",_selectdate)})}input.removeClass("on");that.container.remove();input.change()})})},_changeInstalldate:function(input,str){var _str="#"+str;if($(_str).length){var _arr=input.attr("selectdate").split("-");var _dateYear=_arr[0];var _dateMonth=_arr[1]-1;var _dateDate=_arr[2];var _newDate=new Date(_dateYear,_dateMonth,parseInt(_dateDate)+1);var _newDateYear=_newDate.getFullYear();var _newDateMonth=delzero(_newDate.getMonth()+1);var _newDateDate=delzero(_newDate.getDate());var _newDateDay=_newDate.getDay();var _newString1=_newDateYear+"-"+_newDateMonth+"-"+_newDateDate+" "+aryDay[_newDateDay]+timeSection[2];var _newString2=_newDateYear+"-"+_newDateMonth+"-"+_newDateDate;$(_str).val(_newString1);$(_str).attr("startdate",_newString2);$(_str).attr("selectdate",_newString2)}},_tempHeader:{1:['<div class="tit_select fl">',"<ul>",'<li class="top">时段</li>',"<li>白天(09:00-18:00)</li>","</ul>","</div>",'<div class="item_select fl"></div>'],2:['<div class="tit_select fl">',"<ul>",'<li class="top">时段</li>',"<li>上午(09:00-14:00)</li>","<li>下午(14:00-18:00)</li>","</ul>","</div>",'<div class="item_select fl"></div>'],3:['<div class="tit_select fl">',"<ul>",'<li class="top">时段</li>',"<li>上午(09:00-14:00)</li>","<li>下午(14:00-18:00)</li>",'<li class="night"><p>晚上(18:00-22:00)</p></li>',"</ul>","</div>",'<div class="item_select fl"></div>']},tempDateType:{_shiptype1:'<div class="date-type-box"><ul class="clearfix"><li><a href="javascript:void(0)" class="work-day">工作日</a><i></i></li><li><a href="javascript:void(0)" class="day-off">休息日</a><i></i></li><li><a href="javascript:void(0)" class="day-detial">指定送达日期</a><i></i></li></ul></div>',_shiptype2:'<div class="date-type-box"><ul class="clearfix"><li><a href="javascript:void(0)" class="day-detial">指定送达日期</a><i></i></li></ul></div>',_shiptype3:function(num){var msg='<div class="date-type-box"><ul class="clearfix"><li><a href="javascript:void(0)" class="work-day">工作日</a><i></i></li><li><a href="javascript:void(0)" class="day-off">休息日</a><i></i></li><li><a href="javascript:void(0)" class="day-detial">指定送达日期</a><i></i></li><li><a href="javascript:void(0)" class="fast-delivery">急速达（<span class="c-f70">'+num+"小时送达</span>）</a><i></i></li></ul></div>";return msg},_shiptype4:function(num){var msg='<div class="date-type-box"><ul class="clearfix"><li><a href="javascript:void(0)" class="day-detial">指定送达日期</a><i></i></li><li><a href="javascript:void(0)" class="fast-delivery">急速达（<span class="c-f70">'+num+"小时送达</span>）</a><i></i></li></ul></div>";return msg},_installtype:'<div class="date-type-box"><ul class="clearfix"><li><a href="javascript:void(0)" class="day-detial">指定安装日期</a><i></i></li></ul></div>',_deliverinstallType:'<div class="date-type-box"><ul class="clearfix"><li><a href="javascript:void(0)" class="day-sync">送装一体</a><i></i></li><li><a href="javascript:void(0)" class="day-detial">指定安装日期</a><i></i></li></ul></div>'},tempDateTypeContent:{workday:"<div class='date-type-content'><table><tr><td><i class='tip-icon tip-info-24 mr10'></i></td><td><b>您好，商品将在工作日期间（周一到周五）为您送达</b></td></tr></table></div>",dayoff:"<div class='date-type-content'><table><tr><td><i class='tip-icon tip-info-24 mr10'></i></td><td><b>您好，商品将在工作日期间（周六到周日）为您送达</b></td></tr></table></div>",fastDelivery:function(num){var msg="<div class='date-type-content'><table><tr><td><i class='mr10'></i></td><td><b>您好，商品将在下单成功后<span class='c-f70'>"+num+"小时</span>为您送达</b></td></tr></table></div>";return msg},daysync:"<div class='date-type-content'><table><tr><td><i class='tip-icon tip-info-24 mr10'></i></td><td><b>该商品支持送装一体，由售后工程师送货的同时为您安装！</b></td></tr></table></div>"},outClick:function(input){var that=this;$(document).bind("click",function(){input.removeClass("on");that.container.remove()})}};cartCalendarFn.init()};$(function(){ECode.cartCalendar()});